# دليل إدارة الكوكيز (Cookies Management Guide)

هذا الملف يشرح بالتفصيل وظائف ملفات الكوكيز في المشروع والفرق بينها.

## 1. ملف `src/shared/libs/cookies.ts` (المكتبة الأساسية)

هذا هو الملف الرئيسي والشامل لإدارة الكوكيز، ويحتوي على وظائف للتعامل مع الكوكيز في كل من **الخادم (Server-Side)** و **المتصفح (Client-Side)**.

### قائمة الدوال واستخداماتها:

#### أ) دوال الخادم (Server-Side Functions)
تستخدم هذه الدوال داخل **API Routes** (`route.ts`) أو **Middleware** أو **Server Actions**.

| اسم الدالة | الوظيفة | حالة الاستخدام (Use Case) |
|------------|---------|---------------------------|
| `setSessionCookie` | تقوم بتعيين كوكي الجلسة (Session Cookie) بشكل آمن (HttpOnly) في استجابة السيرفر. | عند **تسجيل الدخول** (Login) أو **إنشاء حساب** (Sign Up) بنجاح، لتخزين التوكن في متصفح المستخدم بأمان. |
| `clearSessionCookie` | تقوم بحذف كوكي الجلسة عن طريق تعيين تاريخ انتهاء فوري. | عند **تسجيل الخروج** (Logout) لمسح التوكن من المتصفح. |
| `getSessionToken` | تستخرج التوكن من الكوكيز الموجودة في الطلب القادم (Request). | في **Middleware** أو **API Routes** للتحقق من هوية المستخدم قبل السماح له بالوصول للبيانات. |
| `hasSessionCookie` | تتحقق ببساطة هل يوجد كوكي للجلسة أم لا (True/False). | فحص سريع في **Middleware** لمعرفة هل المستخدم مسجل دخول مبدئياً أم لا. |
| `createResponseWithSession` | دالة مساعدة تنشئ استجابة JSON وتضيف لها كوكي الجلسة في خطوة واحدة. | اختصار مفيد في نهاية الـ API Route الخاص بتسجيل الدخول (بدل كتابة سطرين). |
| `createResponseWithoutSession` | دالة مساعدة تنشئ استجابة JSON وتحذف كوكي الجلسة في خطوة واحدة. | اختصار مفيد في نهاية الـ API Route الخاص بتسجيل الخروج. |
| `getServerSessionToken` | (معلقة حالياً) تقرأ التوكن داخل Server Components. | عند الحاجة لجلب بيانات المستخدم داخل صفحة (Page.tsx) يتم عرضها من السيرفر مباشرة. |

#### ب) دوال المتصفح (Client-Side Functions)
تستخدم هذه الدوال داخل **React Components** (`.tsx`) التي تعمل في المتصفح.

| اسم الدالة | الوظيفة | حالة الاستخدام (Use Case) |
|------------|---------|---------------------------|
| `setCookie` | تنشئ كوكي عادية في المتصفح. | لتخزين إعدادات غير حساسة مثل **اللغة** أو **الوضع الليلي (Dark Mode)**. |
| `getCookie` | تقرأ قيمة كوكي عادية من المتصفح. | لقراءة الإعدادات المحفوظة عند تحميل الصفحة. |
| `deleteCookie` | تحذف كوكي عادية من المتصفح. | عند رغبة المستخدم في إعادة تعيين الإعدادات. |
| `getClientSessionToken` | تحاول قراءة توكن الجلسة من المتصفح. | **ملاحظة:** لن تعمل إذا كانت الكوكي `HttpOnly`. تستخدم فقط إذا قررت جعل الكوكي قابلة للقراءة (أقل أماناً). |

---

## 2. ملف `src/shared/api/cookies.ts` (واجهة المتصفح البسيطة)

هذا ملف صغير ومبسط مخصص **فقط للمتصفح (Client-Side)**.

### قائمة الدوال:

| اسم الدالة | الوظيفة | حالة الاستخدام |
|------------|---------|----------------|
| `getAuthToken` | تحاول قراءة التوكن من الكوكيز في المتصفح. | مشابهة لـ `getClientSessionToken` في الملف الآخر. تستخدم في كود الواجهة الأمامية البسيط الذي لا يحتاج للمكتبة الكاملة. |
| `clearAllCookies` | تقوم بمسح **جميع** الكوكيز الموجودة في الموقع. | دالة تنظيف شاملة، مفيدة عند وجود مشاكل في الكاش أو عند رغبة المستخدم في "تصفير" الموقع تماماً. |

---

## 3. مقارنة بين الملفين

| وجه المقارنة | `src/shared/libs/cookies.ts` | `src/shared/api/cookies.ts` |
|--------------|------------------------------|-----------------------------|
| **الهدف** | مكتبة شاملة (Core Library) لإدارة الأمان والجلسات. | ملف مساعد بسيط (Helper) للواجهة الأمامية. |
| **مكان العمل** | يعمل في **السيرفر** (Node.js) و **المتصفح**. | يعمل في **المتصفح** فقط. |
| **الأمان** | عالي (يدعم `HttpOnly`, `Secure`, `SameSite`). | عادي (يتعامل مع `document.cookie` مباشرة). |
| **الاعتمادية** | يعتمد على `next/server` و `next/headers`. | لا يعتمد على مكتبات Next.js الخاصة بالسيرفر. |
| **متى تستخدمه؟** | في كل عمليات المصادقة (Auth)، الـ API، والـ Middleware. | عند الحاجة لوظائف بسيطة في الواجهة (مثل زر "مسح الكل"). |

## الخلاصة والتوصية

*   **اعتمد بشكل أساسي على `src/shared/libs/cookies.ts`** لأنه الملف المركزي والأكثر أماناً وتكاملاً مع Next.js.
*   استخدم `src/shared/api/cookies.ts` فقط إذا كنت بحاجة لدالة `clearAllCookies` أو كنت تعمل في ملف لا يمكنه استيراد مكتبات السيرفر.
